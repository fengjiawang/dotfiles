import Foundation
import Cocoa

class StatusBarManager {
    private var statusItem: NSStatusItem?
    private var popover: NSPopover?

    init() {
        setupStatusBar()
    }

    deinit {
        popover?.close()
        popover?.contentViewController = nil
        if let item = statusItem {
            NSStatusBar.system.removeStatusItem(item)
        }
    }

    private func setupStatusBar() {
        statusItem = NSStatusBar.system.statusItem(withLength: NSStatusItem.variableLength)

        if let button = statusItem?.button {
            button.image = NSImage(systemSymbolName: "arrow.up.left.and.arrow.down.right", accessibilityDescription: "WindowSnap")
            button.image?.size = NSSize(width: 18, height: 18)

            // Right-click to show settings
            button.sendAction(on: [.rightMouseUp, .leftMouseUp])

            // Use block-based action instead of target-action
            setupButtonAction()
        }

        // Add menu for left-click
        setupMenu()
    }

    private func setupButtonAction() {
        guard let button = statusItem?.button else { return }

        let manager = self

        // Left click - show popover
        let leftClick = NSClickGestureRecognizer(target: manager, action: #selector(handleLeftClick(_:)))
        button.addGestureRecognizer(leftClick)

        // Right click - show settings (button 2 = right mouse button)
        let rightClick = NSClickGestureRecognizer(target: manager, action: #selector(handleRightClick(_:)))
        rightClick.buttonMask = 0x2
        button.addGestureRecognizer(rightClick)
    }

    @objc private func handleLeftClick(_ gesture: NSClickGestureRecognizer) {
        // Toggle popover or show menu
        showPopover()
    }

    @objc private func handleRightClick(_ gesture: NSClickGestureRecognizer) {
        showSettings()
    }

    private func setupMenu() {
        let menu = NSMenu()

        let settingsItem = NSMenuItem(title: "Settings...", action: #selector(showSettings), keyEquivalent: ",")
        settingsItem.target = self
        menu.addItem(settingsItem)

        menu.addItem(NSMenuItem.separator())

        let quitItem = NSMenuItem(title: "Quit WindowSnap", action: #selector(quitApp), keyEquivalent: "q")
        quitItem.target = self
        menu.addItem(quitItem)

        statusItem?.menu = menu
    }

    func showPopover() {
        // Close existing popover if any
        if let existingPopover = popover {
            existingPopover.close()
            existingPopover.contentViewController = nil
        }

        let newPopover = NSPopover()
        newPopover.contentViewController = SettingsViewController()
        newPopover.behavior = .transient
        newPopover.animates = false

        self.popover = newPopover

        if let button = statusItem?.button {
            newPopover.show(relativeTo: button.bounds, of: button, preferredEdge: .minY)
        }
    }

    @objc func showSettings() {
        // Close popover if open
        popover?.close()

        // Show settings window
        NSApp.setActivationPolicy(.regular)

        if let delegate = NSApp.delegate as? AppDelegate {
            delegate.showSettingsWindow()
        }
    }

    @objc func quitApp() {
        NSApp.terminate(nil)
    }
}
