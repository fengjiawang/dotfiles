import SwiftUI

@main
struct WindowSnapApp: App {
    @NSApplicationDelegateAdaptor(AppDelegate.self) var appDelegate

    var body: some Scene {
        Settings {
            EmptyView()
        }
    }
}

@MainActor
class AppDelegate: NSObject, NSApplicationDelegate {
    func applicationDidFinishLaunching(_ notification: Notification) {
        NSApp.setActivationPolicy(.accessory)

        if !AXIsProcessTrusted() {
            showAccessibilityPermissionAlert()
        }

        MenuBarManager.shared.setupMenuBar()
        HotkeyManager.shared.registerHotkey()
    }

    private func showAccessibilityPermissionAlert() {
        // First, trigger the system prompt which will automatically add the app to the list
        let options: NSDictionary = [kAXTrustedCheckOptionPrompt.takeUnretainedValue() as String: true]
        let accessEnabled = AXIsProcessTrustedWithOptions(options)

        if !accessEnabled {
            // Show our custom alert with more information
            let alert = NSAlert()
            alert.messageText = "Accessibility Permission Required"
            alert.informativeText = "WindowSnap needs accessibility access to control window positions.\n\n1. Click 'Open System Settings'\n2. Find 'WindowSnap' in the list\n3. Toggle the switch to enable"
            alert.alertStyle = .warning
            alert.addButton(withTitle: "Open System Settings")
            alert.addButton(withTitle: "Quit")

            let response = alert.runModal()
            if response == .alertFirstButtonReturn {
                // Open System Settings to Privacy & Security
                NSWorkspace.shared.open(URL(fileURLWithPath: "/System/Applications/System Settings.app"))

                // Give it a moment to open, then try to navigate to Accessibility
                DispatchQueue.main.asyncAfter(deadline: .now() + 0.5) {
                    // Try the URL scheme as a fallback
                    if let url = URL(string: "x-apple.systemsettings:com.apple.preference.security?Privacy_Accessibility") {
                        NSWorkspace.shared.open(url)
                    }
                }
            } else {
                NSApp.terminate(nil)
            }
        }
    }
}
