import Cocoa

class StatusBarController {
    
    private var statusItem: NSStatusItem!
    private var settingsWindow: SettingsWindow?
    
    init() {
        setupStatusBar()
    }
    
    private func setupStatusBar() {
        // Create status item with variable length
        statusItem = NSStatusBar.system.statusItem(withLength: NSStatusItem.variableLength)
        
        // Set menu bar icon
        if let button = statusItem.button {
            // Use system icon - we can also use custom image
            button.image = createMenuBarIcon()
            button.image?.isTemplate = true  // Make it work with dark mode
            button.action = #selector(handleClick(_:))
            button.sendAction(on: [.leftMouseUp, .rightMouseUp])
            button.toolTip = "WindowSnap - 点击打开菜单"
        }
    }
    
    /// Create a custom menu bar icon
    private func createMenuBarIcon() -> NSImage {
        let size = NSSize(width: 18, height: 18)
        let image = NSImage(size: size)
        
        image.lockFocus()
        
        // Draw a simple window icon
        let context = NSGraphicsContext.current?.cgContext
        
        // Window frame
        let frameRect = CGRect(x: 2, y: 3, width: 14, height: 12)
        context?.setStrokeColor(NSColor.label.cgColor)
        context?.setLineWidth(1.5)
        context?.stroke(frameRect)
        
        // Title bar
        let titleBarRect = CGRect(x: 2, y: 13, width: 14, height: 2)
        context?.fill(titleBarRect)
        
        // Center dot (representing centering)
        let dotRect = CGRect(x: 8, y: 7, width: 2, height: 2)
        context?.fillEllipse(in: dotRect)
        
        image.unlockFocus()
        image.isTemplate = true
        
        return image
    }
    
    @objc private func handleClick(_ sender: NSStatusBarButton) {
        guard let event = NSApp.currentEvent else { return }
        
        // Handle both left and right click
        if event.type == .rightMouseUp || event.type == .leftMouseUp {
            showMenu()
        }
    }
    
    private func showMenu() {
        let menu = NSMenu()
        
        // Title item
        let titleItem = NSMenuItem(title: "WindowSnap", action: nil, keyEquivalent: "")
        titleItem.isEnabled = false
        menu.addItem(titleItem)
        
        // Separator
        menu.addItem(NSMenuItem.separator())
        
        // Center window now
        let centerItem = NSMenuItem(
            title: "立即居中窗口",
            action: #selector(centerWindowNow),
            keyEquivalent: ""
        )
        centerItem.target = self
        menu.addItem(centerItem)
        
        // Separator
        menu.addItem(NSMenuItem.separator())
        
        // Settings
        let settingsItem = NSMenuItem(
            title: "设置...",
            action: #selector(openSettings),
            keyEquivalent: ","
        )
        settingsItem.target = self
        menu.addItem(settingsItem)
        
        // Separator
        menu.addItem(NSMenuItem.separator())
        
        // About
        let aboutItem = NSMenuItem(
            title: "关于 WindowSnap",
            action: #selector(showAbout),
            keyEquivalent: ""
        )
        aboutItem.target = self
        menu.addItem(aboutItem)
        
        // Separator
        menu.addItem(NSMenuItem.separator())
        
        // Quit
        let quitItem = NSMenuItem(
            title: "退出",
            action: #selector(quitApp),
            keyEquivalent: "q"
        )
        quitItem.target = self
        menu.addItem(quitItem)
        
        // Show menu
        statusItem.menu = menu
        statusItem.button?.performClick(nil)
        statusItem.menu = nil  // Reset to allow custom click handling
    }
    
    // MARK: - Menu Actions
    
    @objc private func centerWindowNow() {
        WindowManager.shared.centerFrontmostWindow()
    }
    
    @objc private func openSettings() {
        if settingsWindow == nil {
            settingsWindow = SettingsWindow()
        }
        
        settingsWindow?.window?.makeKeyAndOrderFront(nil)
        NSApp.activate(ignoringOtherApps: true)
    }
    
    @objc private func showAbout() {
        let alert = NSAlert()
        alert.messageText = "WindowSnap"
        alert.informativeText = "版本 1.0\n\n一个简洁的窗口管理工具，帮助您快速将窗口居中并调整大小。\n\n快捷键: \(getCurrentShortcutString())"
        alert.alertStyle = .informational
        alert.addButton(withTitle: "确定")
        alert.runModal()
    }
    
    @objc private func quitApp() {
        NSApp.terminate(nil)
    }
    
    /// Get current shortcut as readable string
    private func getCurrentShortcutString() -> String {
        let prefs = Preferences.shared
        let modifiers = NSEvent.ModifierFlags(rawValue: prefs.shortcutModifiers)
        let keyString = keyCodeToString(prefs.shortcutKeyCode)
        return "\(modifiers.stringRepresentation)\(keyString)"
    }
}
