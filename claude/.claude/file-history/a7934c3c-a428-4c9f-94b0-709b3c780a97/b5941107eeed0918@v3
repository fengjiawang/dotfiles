import Cocoa

class StatusBarController {
    
    private var statusItem: NSStatusItem!
    private var settingsWindow: SettingsWindow?
    
    init() {
        setupStatusBar()
    }
    
    private func setupStatusBar() {
        // Create status item with variable length
        statusItem = NSStatusBar.system.statusItem(withLength: NSStatusItem.variableLength)
        
        // Set menu bar icon
        if let button = statusItem.button {
            // Use system icon - we can also use custom image
            button.image = createMenuBarIcon()
            button.image?.isTemplate = true  // Make it work with dark mode
            button.action = #selector(handleClick(_:))
            button.sendAction(on: [.leftMouseUp, .rightMouseUp])
            button.toolTip = "WindowSnap - 点击打开菜单"
        }
    }
    
    /// Create a custom menu bar icon using SF Symbol
    private func createMenuBarIcon() -> NSImage? {
        // Use system symbol icon
        let config = NSImage.SymbolConfiguration(pointSize: 16, weight: .medium)
        if let image = NSImage(systemSymbolName: "arrow.up.left.and.arrow.down.right", accessibilityDescription: "WindowSnap") {
            return image.withSymbolConfiguration(config)
        }
        return nil
    }
    
    @objc private func handleClick(_ sender: NSStatusBarButton) {
        guard let event = NSApp.currentEvent else { return }
        
        // Handle both left and right click
        if event.type == .rightMouseUp || event.type == .leftMouseUp {
            showMenu()
        }
    }
    
    private func showMenu() {
        let menu = NSMenu()
        
        // Title item
        let titleItem = NSMenuItem(title: "WindowSnap", action: nil, keyEquivalent: "")
        titleItem.isEnabled = false
        menu.addItem(titleItem)
        
        // Separator
        menu.addItem(NSMenuItem.separator())
        
        // Center window now
        let centerItem = NSMenuItem(
            title: "立即居中窗口",
            action: #selector(centerWindowNow),
            keyEquivalent: ""
        )
        centerItem.target = self
        menu.addItem(centerItem)
        
        // Separator
        menu.addItem(NSMenuItem.separator())
        
        // Settings
        let settingsItem = NSMenuItem(
            title: "设置...",
            action: #selector(openSettings),
            keyEquivalent: ","
        )
        settingsItem.target = self
        menu.addItem(settingsItem)
        
        // Separator
        menu.addItem(NSMenuItem.separator())
        
        // About
        let aboutItem = NSMenuItem(
            title: "关于 WindowSnap",
            action: #selector(showAbout),
            keyEquivalent: ""
        )
        aboutItem.target = self
        menu.addItem(aboutItem)
        
        // Separator
        menu.addItem(NSMenuItem.separator())
        
        // Quit
        let quitItem = NSMenuItem(
            title: "退出",
            action: #selector(quitApp),
            keyEquivalent: "q"
        )
        quitItem.target = self
        menu.addItem(quitItem)
        
        // Show menu
        statusItem.menu = menu
        statusItem.button?.performClick(nil)
        statusItem.menu = nil  // Reset to allow custom click handling
    }
    
    // MARK: - Menu Actions
    
    @objc private func centerWindowNow() {
        WindowManager.shared.centerFrontmostWindow()
    }
    
    @objc private func openSettings() {
        if settingsWindow == nil {
            settingsWindow = SettingsWindow()
        }
        
        settingsWindow?.window?.makeKeyAndOrderFront(nil)
        NSApp.activate(ignoringOtherApps: true)
    }
    
    @objc private func showAbout() {
        let alert = NSAlert()
        alert.messageText = "WindowSnap"
        alert.informativeText = "版本 1.0\n\n一个简洁的窗口管理工具，帮助您快速将窗口居中并调整大小。\n\n快捷键: \(getCurrentShortcutString())"
        alert.alertStyle = .informational
        alert.addButton(withTitle: "确定")
        alert.runModal()
    }
    
    @objc private func quitApp() {
        NSApp.terminate(nil)
    }
    
    /// Get current shortcut as readable string
    private func getCurrentShortcutString() -> String {
        let prefs = Preferences.shared
        let modifiers = NSEvent.ModifierFlags(rawValue: prefs.shortcutModifiers)
        let keyString = keyCodeToString(prefs.shortcutKeyCode)
        return "\(modifiers.stringRepresentation)\(keyString)"
    }
}
